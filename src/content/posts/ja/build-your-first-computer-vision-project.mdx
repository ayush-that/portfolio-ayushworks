---
title: "初めてのコンピュータビジョンプロジェクトを作ろう"
description: Python、OpenCV、手の検出を使ってソロ卓球ゲームを作成します。ステップバイステップのガイド付き。コンピュータビジョン初心者に最適
tags: ["computer-vision", "python", "opencv"]
date: 2024-07-13
published: true
cover: "./images/cover/build-your-first-computer-vision-project.avif"
---

卓球をしたいけどパートナーがいない、そんな経験はありませんか？ちょっとしたコーディングと[コンピュータビジョン](https://en.wikipedia.org/wiki/Computer_vision)があれば、自分だけで遊べるソロ[卓球](https://en.wikipedia.org/wiki/Table_tennis)ゲームを作ることができます！

このブログ投稿では、Python、[OpenCV](https://opencv.org/)、手の検出モジュールを使ってこのゲームを作る方法をステップバイステップでご紹介します。

## SoloPongデモ

ソロ卓球ゲームの実際の動作を見るには、下のデモビデオをご覧ください。ウェブカメラで検出された手のジェスチャーを使ってゲームをプレイしています。

<iframe
  width="560"
  height="315"
  src="https://www.youtube.com/embed/4_GEyFlE7M0?si=lV-2RyX04tJkmqgK"
  title="YouTube video player"
  frameborder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  referrerpolicy="strict-origin-when-cross-origin"
  allowfullscreen
></iframe>
GitHub - [https://github.com/ayush-that/SoloPong](https://github.com/ayush-that/SoloPong)

## 必要なもの

- コンピュータにインストールされた[Python](https://www.python.org/downloads/)
- ウェブカメラ
- [GitHub](https://github.com/ayush-that/SoloPong)リポジトリからの画像素材（ボール、バット、背景、ゲームオーバー画面）

  ![](https://cdn.hashnode.com/res/hashnode/image/upload/v1720892343515/26fd1a83-f262-4f47-baad-793403574a9b.png)

## コードを書く

1. **ライブラリのインポートとカメラの設定**

```python
import numpy as np
import cv2 as cv
import cvzone
from cvzone.HandTrackingModule import HandDetector

cap = cv.VideoCapture(0)
cap.set(3, 1280)
cap.set(4, 720)
```

まず、必要なライブラリをインポートします。画像処理にOpenCV（`cv`）、手の検出に`cvzone`、数値演算に[NumPy](https://numpy.org/doc/stable/)（`np`）を使用します。次に、解像度1280x720でウェブカメラを設定します。

2. **画像素材の読み込み**

```python
imgBg = cv.imread("assets/bg.png")
imgGO = cv.imread("assets/gameover.png")
imgBall = cv.imread("assets/ball.png", cv.IMREAD_UNCHANGED)
imgBat1 = cv.imread("assets/bat1.png", cv.IMREAD_UNCHANGED)
imgBat2 = cv.imread("assets/bat2.png", cv.IMREAD_UNCHANGED)
```

背景、ゲームオーバー画面、ボール、バットの画像を読み込みます。これらの画像がassetsフォルダにあることを確認してください。

3. **手の検出器の設定**

```python
detector = HandDetector(detectionCon=0.8, maxHands=2)
```

検出信頼度0.8で、最大2つの手を検出できる手の検出器を初期化します。

4. **ゲーム変数の初期化**

```python
ballPos = [100, 100]
speedX = 25
speedY = 25
gameOver = False
score = [0, 0]
```

ボールの初期位置と速度を設定します。また、ゲームオーバーフラグとスコアも初期化します。

5. **メインゲームループ**

```python
while True:
    _, img = cap.read()
    img = cv.flip(img, 1)
    imgRaw = img.copy()
```

メインゲームループに入り、ウェブカメラからフレームを読み取り、ミラー効果のために水平に反転します。また、元のフレームのコピーを作成します。

6. **手の検出とバットのオーバーレイ**

```python
hands, img = detector.findHands(img, flipType=False)
img = cv.addWeighted(img, 0.1, imgBg, 0.9, 0)

if hands:
    for hand in hands:
        x, y, w, h = hand["bbox"]
        h1, w1, _ = imgBat1.shape
        y1 = y - h1 // 2
        y1 = np.clip(y1, 20, 415)

        if hand["type"] == "Left":
            img = cvzone.overlayPNG(img, imgBat1, (59, y1))
            if 59 < ballPos[0] < 59 + w1 and y1 < ballPos[1] < y1 + h1:
                speedX = -speedX
                ballPos[0] += 30
                score[0] += 1

        if hand["type"] == "Right":
            img = cvzone.overlayPNG(img, imgBat2, (1195, y1))
            if 1195 - 50 < ballPos[0] < 1195 and y1 < ballPos[1] < y1 + h1:
                speedX = -speedX
                ballPos[0] -= 30
                score[1] += 1
```

フレーム内の手を検出し、手の位置に基づいてバットをオーバーレイします。ボールがバットに当たると、方向が変わり、スコアが更新されます。

7. **ボールの移動と衝突検出**

```python
if ballPos[0] < 40 or ballPos[0] > 1200:
    gameOver = True
if gameOver:
    img = imgGO
    cv.putText(
        img,
        str(score[1] + score[0]).zfill(2),
        (585, 360),
        cv.FONT_HERSHEY_COMPLEX,
        2.5,
        (200, 0, 200),
        5,
    )

else:
    if ballPos[1] >= 500 or ballPos[1] <= 10:
        speedY = -speedY

    ballPos[0] += speedX
    ballPos[1] += speedY

    img = cvzone.overlayPNG(img, imgBall, ballPos)
    cv.putText(
        img,
        str(score[0]),
        (300, 650),
        cv.FONT_HERSHEY_COMPLEX,
        3,
        (255, 255, 255),
        5,
    )
    cv.putText(
        img,
        str(score[1]),
        (900, 650),
        cv.FONT_HERSHEY_COMPLEX,
        3,
        (255, 255, 255),
        5,
    )
```

ボールの位置を更新し、画面端との衝突をチェックします。ボールが境界外に出るとゲームオーバーになります。そうでなければ、ボールの位置を更新し続け、フレームにオーバーレイします。

8. **ゲームの表示**

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1720892600594/523b8490-cba7-45c6-b6cd-3b516b3ff6dc.png)

```python
img[580:700, 20:233] = cv.resize(imgRaw, (213, 120))
cv.imshow("Image", img)
key = cv.waitKey(1)
if key == ord("r"):
    ballPos = [100, 100]
    speedX = 25
    speedY = 25
    gameOver = False
    score = [0, 0]
    imgGO = cv.imread("assets/gameover.png")
```

ゲームフレームを表示し、「R」キーの押下でゲームをリセットします。

![](https://cdn.hashnode.com/res/hashnode/image/upload/v1720892568086/67aa413b-01c6-4c90-b153-2239c04e13ef.png)

最後までお読みいただきありがとうございます！自分だけのソロ卓球ゲームを作って楽しんでください。質問や問題があれば、コメント欄にお気軽にどうぞ。
